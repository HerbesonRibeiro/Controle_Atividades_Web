{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="content-container">

    <h1 class="page-title"><i class="fas fa-chart-line"></i> Dashboard</h1>

    <div class="info-card" style="margin-bottom: 20px; padding: 15px;">
        <form method="GET" action="{{ url_for('dashboard') }}" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">

            {% if request.args.get('view_as_user_id') %}
                <input type="hidden" name="view_as_user_id" value="{{ request.args.get('view_as_user_id') }}">
            {% endif %}

            <div class="form-group" style="margin-bottom: 0;">
                <label for="data_inicio" style="font-weight: 600; font-size: 0.9rem;">Data Início:</label>
                <input type="date" id="data_inicio" name="data_inicio" value="{{ filtros.data_inicio }}" class="form-control" required>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label for="data_fim" style="font-weight: 600; font-size: 0.9rem;">Data Fim:</label>
                <input type="date" id="data_fim" name="data_fim" value="{{ filtros.data_fim }}" class="form-control" required>
            </div>

            <button type="submit" class="btn btn-primary" style="height: 38px;">
                <i class="fas fa-filter"></i> Filtrar
            </button>

            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" style="height: 38px; display: flex; align-items: center; text-decoration: none;">
                Limpar
            </a>
        </form>
    </div>

    {# --- SELETOR DE VISÃO (APENAS ADMINISTRADOR) --- #}
    {% if session.colaborador_perfil == 'Administrador' %}
        <div class="info-card">
            <form method="GET" action="{{ url_for('dashboard') }}">
                <input type="hidden" name="data_inicio" value="{{ filtros.data_inicio }}">
                <input type="hidden" name="data_fim" value="{{ filtros.data_fim }}">

                <div class="form-row">
                    <div class="form-group">
                        <label for="view_as_user_id" style="font-weight: 700;">VISÃO DO ADMINISTRADOR</label>
                        <select name="view_as_user_id" id="view_as_user_id" onchange="this.form.submit()">
                            <option value="">-- Visão Geral (Admin) --</option>
                            {% for gestor in gestores_disponiveis %}
                                <option value="{{ gestor.id }}" {% if gestor.id|string == request.args.get('view_as_user_id') %}selected{% endif %}>
                                    Ver como: {{ gestor.nome }} (Setor: {{ gestor.setor or 'N/A' }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if request.args.get('view_as_user_id') %}
                    <div class="form-group" style="align-self: flex-end;">
                        <a href="{{ url_for('dashboard') }}" class="btn-secondary">
                            <i class="fas fa-undo"></i> Voltar para Minha Visão
                        </a>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
    {% endif %}

    {# --- LÓGICA DE EXIBIÇÃO UNIFICADA --- #}

    {# 1. VISÃO DE GESTOR (Ou Admin Personificando Gestor) #}
    {% if session.colaborador_perfil == 'Gestor' or (session.colaborador_perfil == 'Administrador' and is_impersonating) %}

        <div class="dashboard-grid">
            <div class="kpi-card">
                <h3>Atividades do Setor</h3>
                <p class="kpi-number">{{ kpis.get('total_atividades_setor', 0) }}</p>
                <i class="fas fa-tasks kpi-icon"></i>
            </div>
            <div class="kpi-card clickable" onclick="abrirModalColaboradoresGestor({{ dados_extras.setor_id_gestor }}, '{{ dados_extras.setor_nome_gestor }}')">
                <h3>Atividades Hoje (Setor)</h3>
                <p class="kpi-number">{{ kpis.get('atividades_hoje_setor', 0) }}</p>
                <i class="fas fa-calendar-day kpi-icon"></i>
            </div>
            <div class="kpi-card">
                <h3>Colaboradores no Setor</h3>
                <p class="kpi-number">{{ kpis.get('total_colaboradores_setor', 0) }}</p>
                <i class="fas fa-users kpi-icon"></i>
            </div>
            <div class="kpi-card">
                <h3>Destaque do Setor</h3>
                <p class="kpi-highlight">{{ dados_extras.colaborador_top_setor.nome if dados_extras.colaborador_top_setor else 'N/A' }}</p>
                <span class="kpi-subtext">{{ dados_extras.colaborador_top_setor.total_atividades if dados_extras.colaborador_top_setor else 0 }} atividades</span>
                <i class="fas fa-user-graduate kpi-icon"></i>
            </div>
        </div>

        <div class="dashboard-row">
            <div class="info-card list-card">
                <h3><i class="fas fa-trophy"></i> Top 5 do Setor ({{ dados_extras.mes_referencia }})</h3>
                <ul>
                    {% for colaborador in dados_extras.top_colaboradores_mes %}
                    <li>
                        <span>{{ loop.index }}. {{ colaborador.nome }}</span>
                        <span class="list-count">{{ colaborador.total_atividades }}</span>
                    </li>
                    {% else %}
                    <li>Nenhuma atividade registrada este mês no setor.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="info-card list-card">
                <h3>Top 5 Atividades do Setor</h3>
                <ul>
                    {% for atividade in dados_extras.get('top_atividades_setor', []) %}
                    <li><span>{{ atividade.nome }}</span><span class="list-count">{{ atividade.total }}</span></li>
                    {% else %}
                    <li>Nenhuma atividade no setor.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    {# 2. VISÃO DE ADMINISTRADOR GERAL (Sem personificação) #}
    {% elif session.colaborador_perfil == 'Administrador' and not is_impersonating %}

        <div class="dashboard-grid">
            <div class="kpi-card">
                <h3>Total de Atividades</h3>
                <p class="kpi-number">{{ kpis.get('total_atividades', 0) }}</p>
                <i class="fas fa-tasks kpi-icon"></i>
            </div>
            <div id="kpi-atividades-hoje-admin" class="kpi-card clickable" onclick="abrirModalAtividadesHoje()">
                <h3>Atividades Hoje</h3>
                <p class="kpi-number">{{ kpis.get('atividades_hoje', 0) }}</p>
                <i class="fas fa-calendar-day kpi-icon"></i>
            </div>
            <div class="kpi-card">
                <h3>Colaboradores Ativos</h3>
                <p class="kpi-number">{{ kpis.get('total_colaboradores', 0) }}</p>
                <i class="fas fa-user-check kpi-icon"></i>
            </div>
            <div class="kpi-card">
                <h3>Setor mais Ativo (Mês)</h3>
                <p class="kpi-highlight">{{ dados_extras.setor_mais_ativo.nome_setor if dados_extras.setor_mais_ativo else 'N/A' }}</p>
                <span class="kpi-subtext">{{ dados_extras.setor_mais_ativo.total_atividades if dados_extras.setor_mais_ativo else 0 }} atividades</span>
                <i class="fas fa-building kpi-icon"></i>
            </div>
        </div>

        <div class="dashboard-row">
            <div class="info-card list-card">
                <h3><i class="fas fa-trophy"></i> Top 5 Colaboradores ({{ dados_extras.mes_referencia }})</h3>
                <ul>
                    {% for colaborador in dados_extras.top_colaboradores_mes %}
                    <li><span>{{ loop.index }}. {{ colaborador.nome }}</span><span class="list-count">{{ colaborador.total_atividades }}</span></li>
                    {% else %}
                    <li>Nenhuma atividade registrada este mês.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="info-card list-card">
                <h3>Colaboradores Ativos/Setor</h3>
                <ul>
                    {% for item in dados_extras.get('colaboradores_por_setor', []) %}
                        {# --- FILTRO PARA OCULTAR UNINTAFLIX--- #}
                        {% if item.nome_setor != 'UNINTAFLIX' %}
                            <li style="cursor: pointer; transition: background 0.2s;"
                                onmouseover="this.style.backgroundColor='#f0f0f0'"
                                onmouseout="this.style.backgroundColor='transparent'"
                                onclick="abrirModalAtivosSetor('{{ item.nome_setor }}')">

                                <span>{{ item.nome_setor }}</span>
                                <span class="list-count">{{ item.total_colaboradores }}</span>
                            </li>
                        {% endif %}
                     {% endfor %}
                </ul>
            </div>
            <div class="info-card list-card">
                <h3>Top 5 Atividades (Mês)</h3>
                <ul>
                    {% for atividade in dados_extras.get('top_atividades', []) %}
                    <li><span>{{ atividade.nome }}</span><span class="list-count">{{ atividade.total }}</span></li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    {# 3. VISÃO DO COLABORADOR #}
    {% else %}
        <div class="dashboard-grid">
            <div class="kpi-card">
                <h3>Minhas Atividades Totais</h3>
                <p class="kpi-number">{{ kpis.get('total_atividades', 0) }}</p>
                <i class="fas fa-tasks kpi-icon"></i>
            </div>
            <div class="kpi-card">
                <h3>Minhas Atividades Hoje</h3>
                <p class="kpi-number">{{ kpis.get('atividades_hoje', 0) }}</p>
                <i class="fas fa-calendar-day kpi-icon"></i>
            </div>
        </div>
        <div class="info-card" style="margin-top: 20px;">
            <p>Resumo pessoal. Veja detalhes no <a href="{{ url_for('historico') }}">Histórico</a>.</p>
        </div>
    {% endif %}

    <div style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">

        <div class="info-card" style="flex: 2; min-width: 400px;">
            <h2>Atividades por Período</h2>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="atividadesChart"></canvas>
            </div>
        </div>

        <div class="info-card" style="flex: 1; min-width: 300px;">
            <h2>Volume por Setor</h2>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="setoresChart"></canvas>
            </div>
        </div>

    </div>

</div>

<div id="modal-hoje-setor" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <button id="modal-back-btn" class="modal-back-btn icon-btn" onclick="carregarDadosModalSetores()" style="display: none;"><i class="fas fa-arrow-left"></i></button>
            <h2 id="modal-title">Atividades de Hoje por Setor</h2>
            <button class="modal-close-btn" onclick="fecharModalSetoresHoje()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="table-container">
                <table class="styled-table">
                    <thead><tr><th>Setor</th><th>Total de Atividades</th></tr></thead>
                    <tbody id="modal-body-setores"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modal-ativos-setor" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h2 id="titulo-modal-ativos">Colaboradores Ativos</h2>
            <button class="modal-close-btn" onclick="fecharModalAtivosSetor()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Total Atividades (Geral)</th>
                        </tr>
                    </thead>
                    <tbody id="lista-ativos-body">
                        <tr><td colspan="2">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {

        // =======================================================
        // 1. GRÁFICO DE BARRAS
        // =======================================================
        const ctxBarras = document.getElementById('atividadesChart').getContext('2d');
        const labelsBarras = {{ labels_grafico | tojson }};
        const datasetsBarras = {{ datasets_grafico | tojson }};

        const userProfile = "{{ session.colaborador_perfil }}";
        const isImpersonating = {{ is_impersonating | tojson }};

        let chartTitleText = 'Atividades Diárias';

        if (userProfile === 'Administrador' && !isImpersonating) {
            chartTitleText = 'Atividades Diárias por Setor';
        } else if (userProfile === 'Gestor' || (userProfile === 'Administrador' && isImpersonating)) {
            chartTitleText = 'Atividades Diárias por Colaborador do Setor';
        }

        new Chart(ctxBarras, {
            type: 'bar',
            data: { labels: labelsBarras, datasets: datasetsBarras },
            options: {
                plugins: {
                    title: { display: true, text: chartTitleText },
                    legend: { position: 'top' },
                },
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                }
            }
        });

        // =======================================================
        // 2. GRÁFICO DE ROSCA
        // =======================================================

        // Preparando Labels (EXCLUINDO UNINTAFLIX)
        const labelsSetor = [
            {% for item in dados_extras.get('volume_por_setor', []) %}
                {% if item.nome_setor not in ['UNINTAFLIX', 'Setor Pedagógico'] %}
                    "{{ item.nome_setor }}",
                {% endif %}
            {% endfor %}
        ];

        // Preparando Dados (EXCLUINDO UNINTAFLIX - Case Corrected)
        const dataSetor = [
            {% for item in dados_extras.get('volume_por_setor', []) %}
                {% if item.nome_setor not in ['UNINTAFLIX', 'Setor Pedagógico'] %}
                    {{ item.total }},
                {% endif %}
            {% endfor %}
        ];

        const ctxRosca = document.getElementById('setoresChart').getContext('2d');

        new Chart(ctxRosca, {
            type: 'doughnut',
            data: {
                labels: labelsSetor,
                datasets: [{
                    data: dataSetor,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                        '#858796', '#5a5c69', '#2e59d9', '#17a673', '#2c9faf'
                    ],
                    borderWidth: 1,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 12, font: { size: 11 } }
                    },
                    title: {
                        display: true,
                        text: 'Distribuição por Setores'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                let value = context.raw;
                                let total = context.chart._metasets[context.datasetIndex].total;
                                let percentage = ((value / total) * 100).toFixed(1) + '%';
                                return label + value + ' (' + percentage + ')';
                            }
                        }
                    }
                },
                cutout: '65%',
            }
        });
    });

    // =======================================================
    // 3. FUNÇÕES DOS MODAIS (ADICIONADAS PARA FUNCIONAR O CLIQUE)
    // =======================================================

    function fecharModalAtivosSetor() {
        document.getElementById('modal-ativos-setor').style.display = 'none';
    }

    function abrirModalAtivosSetor(nomeSetor) {
        const modal = document.getElementById('modal-ativos-setor');
        const titulo = document.getElementById('titulo-modal-ativos');
        const tbody = document.getElementById('lista-ativos-body');

        modal.style.display = 'flex';
        titulo.innerText = 'Colaboradores Ativos: ' + nomeSetor;
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center"><i class="fas fa-spinner fa-spin"></i> Buscando dados...</td></tr>';

        // Chamada à API Python
        fetch(`/api/colaboradores_setor?setor=${encodeURIComponent(nomeSetor)}`)
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2">Nenhum colaborador encontrado.</td></tr>';
                    return;
                }

                data.forEach(colab => {
                    const row = `
                        <tr>
                            <td>${colab.nome}</td>
                            <td>${colab.total_atividades || 0}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Erro:', error);
                tbody.innerHTML = '<tr><td colspan="2" style="color:red">Erro ao carregar dados.</td></tr>';
            });
    }

    // Fecha o modal ao clicar fora
    window.onclick = function(event) {
        const modalAtivos = document.getElementById('modal-ativos-setor');
        const modalHoje = document.getElementById('modal-hoje-setor');

        if (event.target == modalAtivos) {
            fecharModalAtivosSetor();
        }
        if (event.target == modalHoje && typeof fecharModalSetoresHoje === 'function') {
            fecharModalSetoresHoje();
        }
    }

    // Funções placeholder caso não existam no base.html (evita erros)
    function abrirModalAtividadesHoje() {
        // Implementar se necessário ou verificar base.html
    }
    function fecharModalSetoresHoje() {
        document.getElementById('modal-hoje-setor').style.display = 'none';
    }
    function carregarDadosModalSetores() {
        // Implementar lógica de voltar se necessário
    }
</script>
{% endblock %}