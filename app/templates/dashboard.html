{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="content-container">

    <h1 class="page-title"><i class="fas fa-chart-line"></i> Dashboard</h1>

    {# --- INÍCIO DA LÓGICA DE EXIBIÇÃO POR PERFIL --- #}

 {# --- 1. VISÃO DO ADMINISTRADOR --- #}
    {% if session.colaborador_perfil == 'Administrador' %}

        <div class="info-card">
            <form method="GET" action="{{ url_for('dashboard') }}">
                <div class="form-row">
                    <div class="form-group">
                        <label for="view_as_user_id" style="font-weight: 700;">VISÃO DO ADMINISTRADOR</label>
                        <select name="view_as_user_id" id="view_as_user_id" onchange="this.form.submit()">
                            <option value="">-- Ver a dashboard de Gestor --</option>
                            {% for gestor in gestores_disponiveis %}
                                <option value="{{ gestor.id }}" {% if gestor.id|string == request.args.get('view_as_user_id') %}selected{% endif %}>
                                    {{ gestor.nome }} (Setor: {{ gestor.setor or 'N/A' }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if request.args.get('view_as_user_id') %}
                    <div class="form-group" style="align-self: flex-end;">
                        <a href="{{ url_for('dashboard') }}" class="btn-secondary">
                            <i class="fas fa-undo"></i> Voltar para Minha Visão
                        </a>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>

        {# --- Lógica que decide qual visão mostrar para o Admin --- #}
        {% if is_impersonating %}

            {# Se o admin ESTÁ personificando, mostra a visão do GESTOR #}
            <div class="dashboard-grid">
                <div class="kpi-card">
                    <h3>Atividades do Setor</h3>
                    <p class="kpi-number">{{ kpis.get('total_atividades_setor', 0) }}</p>
                    <i class="fas fa-tasks kpi-icon"></i>
                </div>
                <div class="kpi-card clickable" onclick="abrirModalColaboradoresGestor({{ dados_extras.setor_id_gestor }}, '{{ dados_extras.setor_nome_gestor }}')">
                    <h3>Atividades Hoje (Setor)</h3>
                    <p class="kpi-number">{{ kpis.get('atividades_hoje_setor', 0) }}</p>
                    <i class="fas fa-calendar-day kpi-icon"></i>
                </div>
                <div class="kpi-card">
                    <h3>Colaboradores no Setor</h3>
                    <p class="kpi-number">{{ kpis.get('total_colaboradores_setor', 0) }}</p>
                    <i class="fas fa-users kpi-icon"></i>
                </div>
                <div class="kpi-card">
                    <h3>Destaque do Setor (Mês)</h3>
                    <p class="kpi-highlight">{{ dados_extras.colaborador_top_setor.nome if dados_extras.colaborador_top_setor else 'N/A' }}</p>
                    <span class="kpi-subtext">{{ dados_extras.colaborador_top_setor.total_atividades if dados_extras.colaborador_top_setor else 0 }} atividades</span>
                    <i class="fas fa-user-graduate kpi-icon"></i>
                </div>
            </div>
                <div class="dashboard-row">
                    <div class="info-card list-card">
                        <h3><i class="fas fa-trophy"></i> Top 5 do Setor ({{ dados_extras.mes_referencia }})</h3>
                        <ul>
                            {% for colaborador in dados_extras.top_colaboradores_mes %}
                            <li>
                                <span>{{ loop.index }}. {{ colaborador.nome }}</span>
                                <span class="list-count">{{ colaborador.total_atividades }}</span>
                            </li>
                            {% else %}
                            <li>Nenhuma atividade registrada este mês no setor.</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="info-card list-card">
                        <h3>Top 3 Atividades do Setor (Mês)</h3>
                        <ul>
                            {% for atividade in dados_extras.get('top_atividades_setor', []) %}
                            <li><span>{{ atividade.nome }}</span><span class="list-count">{{ atividade.total }}</span></li>
                            {% else %}
                            <li>Nenhuma atividade no setor.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

    {% else %}

            {# Se o admin NÃO está personificando, mostra a visão normal de ADMIN #}

            <div class="dashboard-grid">

                <div class="kpi-card">
                    <h3>Total de Atividades</h3>
                    <p class="kpi-number">{{ kpis.get('total_atividades', 0) }}</p>
                    <i class="fas fa-tasks kpi-icon"></i>
                </div>

                <div id="kpi-atividades-hoje-admin" class="kpi-card clickable" onclick="abrirModalAtividadesHoje()">
                    <h3>Atividades Hoje</h3>
                    <p class="kpi-number">{{ kpis.get('atividades_hoje', 0) }}</p>
                    <i class="fas fa-calendar-day kpi-icon"></i>
                </div>

                <div class="kpi-card">
                    <h3>Colaboradores Ativos</h3>
                    <p class="kpi-number">{{ kpis.get('total_colaboradores', 0) }}</p>
                    <i class="fas fa-user-check kpi-icon"></i>
                </div>

                <div class="kpi-card">
                    <h3>Setor com Mais Atividades (Mês)</h3>
                    <p class="kpi-highlight">{{ dados_extras.setor_mais_ativo.nome_setor if dados_extras.setor_mais_ativo else 'N/A' }}</p>
                    <span class="kpi-subtext">{{ dados_extras.setor_mais_ativo.total_atividades if dados_extras.setor_mais_ativo else 0 }} atividades</span>
                    <i class="fas fa-building kpi-icon"></i>
                </div>

            </div> <div class="dashboard-row">
                <div class="info-card list-card">
                    <h3><i class="fas fa-trophy"></i> Top 5 Colaboradores ({{ dados_extras.mes_referencia }})</h3>
                    <ul>
                        {% for colaborador in dados_extras.top_colaboradores_mes %}
                        <li>
                            <span>{{ loop.index }}. {{ colaborador.nome }}</span>
                            <span class="list-count">{{ colaborador.total_atividades }}</span>
                        </li>
                        {% else %}
                        <li>Nenhuma atividade registrada este mês.</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="info-card list-card">
                    <h3>Colaboradores Ativos por Setor</h3>
                    <ul>
                        {% for item in dados_extras.get('colaboradores_por_setor', []) %}
                        <li><span>{{ item.nome_setor }}</span><span class="list-count">{{ item.total_colaboradores }}</span></li>
                        {% else %}
                        <li>Nenhum dado encontrado.</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="info-card list-card">
                    <h3>Top 3 Atividades (Mês)</h3>
                    <ul>
                        {% for atividade in dados_extras.get('top_atividades', []) %}
                        <li><span>{{ atividade.nome }}</span><span class="list-count">{{ atividade.total }}</span></li>
                        {% else %}
                        <li>Nenhuma atividade registrada.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

    {# --- 2. VISÃO DO GESTOR --- #}
    {% elif session.colaborador_perfil == 'Gestor' %}

        <div class="dashboard-grid">
            <div class="kpi-card">
                <h3>Atividades do Setor</h3>
                <p class="kpi-number">{{ kpis.get('total_atividades_setor', 0) }}</p>
                <i class="fas fa-tasks kpi-icon"></i>
            </div>
            <div class="kpi-card clickable" onclick="abrirModalColaboradoresGestor({{ dados_extras.setor_id_gestor }}, '{{ dados_extras.setor_nome_gestor }}')">
                <h3>Atividades Hoje (Setor)</h3>
                <p class="kpi-number">{{ kpis.get('atividades_hoje_setor', 0) }}</p>
                <i class="fas fa-calendar-day kpi-icon"></i>
            </div>
            <div class="kpi-card">
                <h3>Colaboradores no Setor</h3>
                <p class="kpi-number">{{ kpis.get('total_colaboradores_setor', 0) }}</p>
                <i class="fas fa-users kpi-icon"></i>
            </div>
            <div class="kpi-card">
                <h3>Destaque do Setor (Geral)</h3>
                <p class="kpi-highlight">{{ dados_extras.colaborador_top_setor.nome if dados_extras.colaborador_top_setor else 'N/A' }}</p>
                <span class="kpi-subtext">{{ dados_extras.colaborador_top_setor.total_atividades if dados_extras.colaborador_top_setor else 0 }} atividades</span>
                <i class="fas fa-user-graduate kpi-icon"></i>
            </div>
        </div>

        <div class="dashboard-row">
            <div class="info-card list-card">
                <h3><i class="fas fa-trophy"></i> Top 5 do Setor ({{ dados_extras.mes_referencia }})</h3>
                <ul>
                    {% for colaborador in dados_extras.top_colaboradores_mes %}
                    <li>
                        <span>{{ loop.index }}. {{ colaborador.nome }}</span>
                        <span class="list-count">{{ colaborador.total_atividades }}</span>
                    </li>
                    {% else %}
                    <li>Nenhuma atividade registrada este mês no setor.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="info-card list-card">
                <h3>Top 3 Atividades do Setor</h3>
                <ul>
                    {% for atividade in dados_extras.get('top_atividades_setor', []) %}
                    <li><span>{{ atividade.nome }}</span><span class="list-count">{{ atividade.total }}</span></li>
                    {% else %}
                    <li>Nenhuma atividade no setor.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    {# --- 3. VISÃO DO COLABORADOR --- #}
    {% else %}
        <div class="dashboard-grid">
            <div class="kpi-card">
                <h3>Minhas Atividades Totais</h3>
                <p class="kpi-number">{{ kpis.get('total_atividades', 0) }}</p>
                <i class="fas fa-tasks kpi-icon"></i>
            </div>
            <div class="kpi-card">
                <h3>Minhas Atividades Hoje</h3>
                <p class="kpi-number">{{ kpis.get('atividades_hoje', 0) }}</p>
                <i class="fas fa-calendar-day kpi-icon"></i>
            </div>
        </div>
        <div class="info-card" style="margin-top: 20px;">
            <p>Este é um resumo das suas atividades pessoais. Para mais detalhes, acesse o <a href="{{ url_for('historico') }}">Histórico de Atividades</a>.</p>
        </div>

    {% endif %}
    {# --- FIM DA LÓGICA DE EXIBIÇÃO POR PERFIL --- #}

    <div class="info-card" style="margin-top: 20px;">
        <h2>Atividades nos Últimos 7 Dias</h2>
        <div class="chart-container">
            <canvas id="atividadesChart"></canvas>
        </div>
    </div>

</div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('atividadesChart').getContext('2d');
            const labels = {{ labels_grafico | tojson }};
            const datasets = {{ datasets_grafico | tojson }};

            // Lógica para determinar o título do gráfico
            let chartTitleText = 'Atividades Diárias';
            const userProfile = "{{ session.colaborador_perfil }}";
            if (userProfile === 'Administrador') {
                chartTitleText = 'Atividades Diárias por Setor';
            } else if (userProfile === 'Gestor') {
                chartTitleText = 'Atividades Diárias por Colaborador do Setor';
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    plugins: {
                        title: { display: true, text: chartTitleText },
                        legend: { position: 'top' },
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'Data' }},
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Quantidade de Atividades' }}
                    }
                }
            });
        });
    </script>

    {# --- INICIO DOS MODAL DA DASHBOARD --- #}

<div id="modal-hoje-setor" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <button id="modal-back-btn" class="modal-back-btn icon-btn" onclick="carregarDadosModalSetores()" style="display: none;" title="Voltar">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 id="modal-title">Atividades de Hoje por Setor</h2>
            <button class="modal-close-btn" onclick="fecharModalSetoresHoje()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Abaixo está o resumo de atividades registradas hoje, separadas por setor.</p>
            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Setor</th>
                            <th>Total de Atividades</th>
                        </tr>
                    </thead>
                    <tbody id="modal-body-setores">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}